<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a2332">
    <title>ADC Class of 2029 Chat</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-title">
                <h1>üéì ADC 2029</h1>
                <span class="header-subtitle">Live Chat</span>
            </div>

            <div style="display:flex;align-items:center;gap:8px;">
                <button class="header-refresh-btn" id="headerRefreshBtn" aria-label="Refresh">üîÑ</button>
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Connecting...</span>
                </div>
                <!-- Bell notification button -->
                <div class="bell-wrapper" style="position:relative;">
                    <button class="header-bell-btn" id="headerBellBtn" aria-label="Notifications">üîî</button>
                    <span class="bell-badge" id="bellBadge" style="display:none;">0</span>
                </div>
                <!-- Mobile: settings gear in header -->
                <button class="header-settings-btn" id="headerSettingsBtn" aria-label="Settings">‚öôÔ∏è</button>
            </div>
        </header>

        <div class="chat-container" id="chatContainer">
            <!-- Pull-to-refresh indicator -->
            <div class="pull-refresh-indicator" id="pullRefreshIndicator">
                <div class="pull-refresh-spin" id="pullRefreshSpin"></div>
                <span id="pullRefreshText">Pull to refresh</span>
            </div>

            <div id="messages" class="messages"></div>
            <div id="typingIndicator" class="typing-indicator" style="display:none;">
                <div class="typing-dots"><span></span><span></span><span></span></div>
                <span id="typingText"></span>
            </div>
        </div>

        <div class="input-container" id="inputContainer">
            <input
                type="text"
                id="messageInput"
                placeholder="Message..."
                maxlength="500"
                autocomplete="off"
                autocorrect="on"
                autocapitalize="sentences"
                enterkeyhint="send"
            />
            <button class="game-btn" id="gameBtn" onclick="openGameMenu()" aria-label="Games" title="Play a game">üéÆ</button>
            <button id="sendBtn">Send</button>
        </div>
    </div>

    <!-- Desktop settings button (bottom-left FAB) -->
    <button class="settings-btn" id="settingsBtn" aria-label="Settings">‚öôÔ∏è</button>

    <!-- Settings overlay -->
    <div class="settings-overlay" id="settingsOverlay"></div>

    <!-- Settings panel (bottom sheet on mobile, floating on desktop, side drawer on tablet) -->
    <div class="settings-panel" id="settingsPanel" role="dialog" aria-label="Settings">
        <div class="settings-header">
            <h3>‚öôÔ∏è Settings</h3>
            <button class="settings-close-btn" id="settingsCloseBtn" aria-label="Close settings">‚úï</button>
        </div>
        <div class="settings-content">
            <div class="settings-section">
                <h4>Profile Photo</h4>
                <div class="profile-image-section">
                    <div class="profile-avatar" id="profileAvatar" title="Click to change photo">
                        <span id="profileInitials">?</span>
                        <img id="profileImage" style="display:none;" alt="Profile">
                        <div class="profile-avatar-overlay">üì∑</div>
                    </div>
                    <input type="file" id="profileImageInput" accept="image/*">
                    <button class="image-upload-btn" id="uploadImageBtn">üì∑ Change Photo</button>
                    <div id="uploadStatus" class="upload-status"></div>
                </div>
            </div>

            <div class="settings-section">
                <h4>Account</h4>
                <div class="account-info">
                    <p><strong>Name:</strong> <span id="accountName">Loading...</span></p>
                    <p><strong>Email:</strong> <span id="accountEmail">Loading...</span></p>
                </div>
                <div class="change-name-section" id="changeNameSection" style="display:none;">
                    <input type="text" id="changeNameInput" class="change-name-input" placeholder="New display name" maxlength="30">
                    <div class="change-name-buttons">
                        <button class="save-name-btn" id="saveNameBtn">‚úì Save</button>
                        <button class="cancel-name-btn" id="cancelNameBtn">‚úï Cancel</button>
                    </div>
                    <div id="changeNameStatus" class="upload-status"></div>
                </div>
                <button class="change-name-btn" id="changeNameBtn">‚úèÔ∏è Change Name</button>
                <button class="logout-btn" id="logoutBtn">üö™ Logout</button>
            </div>

            <div class="settings-section">
                <h4>Members</h4>
                <button class="members-btn" id="membersBtn">üë• View All Members</button>
            </div>
        </div>
    </div>

    <!-- Notifications panel -->
    <div class="notifications-overlay" id="notificationsOverlay"></div>
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <h3>üîî Notifications</h3>
            <button class="notifications-close" id="notificationsClose">‚úï</button>
        </div>
        <div class="notifications-list" id="notificationsList">
            <div style="text-align:center;color:#888;padding:20px;">No notifications</div>
        </div>
    </div>

    <!-- Delete confirmation modal -->
    <div class="modal-overlay" id="deleteModal" role="dialog" aria-label="Confirm delete">
        <div class="modal">
            <h3>Delete Message?</h3>
            <p>This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="cancelDelete()">Cancel</button>
                <button class="modal-btn confirm" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Image Cropper Modal -->
    <div class="cropper-modal-overlay" id="cropperModal" role="dialog" aria-label="Crop photo">
        <div class="cropper-modal">
            <div class="cropper-modal-header">
                <h3>‚úÇÔ∏è Crop Photo</h3>
                <button class="cropper-close-btn" id="cropperCloseBtn">‚úï</button>
            </div>
            <div class="cropper-viewport" id="cropperViewport">
                <!-- Canvas drawn by JS -->
            </div>
            <div class="cropper-instruction">Drag to move ‚Ä¢ Scroll/pinch to zoom</div>
            <div class="cropper-footer">
                <div class="cropper-preview">
                    <img id="cropperPreview" src="" alt="Preview">
                </div>
                <div class="cropper-actions">
                    <button class="cropper-btn cancel" id="cropperCancelBtn">Cancel</button>
                    <button class="cropper-btn save" id="cropperSaveBtn">Save Photo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Nested Tic-Tac-Toe Full Screen -->
    <div class="nttt-overlay" id="ntttOverlay">
        <!-- Top bar -->
        <div class="nttt-topbar">
            <div class="nttt-tabs">
                <button class="nttt-tab active" id="ntttTabContinue" onclick="ntttShowTab('continue')">Continue</button>
                <button class="nttt-tab" id="ntttTabInvites" onclick="ntttShowTab('invites')">
                    Invites
                    <span class="nttt-tab-badge" id="ntttInvitesBadge" style="display:none;">0</span>
                </button>
                <button class="nttt-tab" id="ntttTabNew" onclick="ntttShowTab('new')">New</button>
            </div>
            <button class="nttt-close" onclick="closeNTTT()">‚úï</button>
        </div>

        <!-- CONTINUE TAB -->
        <div class="nttt-panel" id="ntttPanelContinue">
            <div class="nttt-game-list" id="ntttGameList">
                <div class="nttt-empty">No active games. Start one in New!</div>
            </div>
            <!-- Active game board (shown when a game is open) -->
            <div class="nttt-board-area" id="ntttBoardArea" style="display:none;">
                <div class="nttt-game-header">
                    <button class="nttt-back-btn" onclick="ntttBackToList()">‚Üê Games</button>
                    <div class="nttt-game-info">
                        <span class="nttt-game-title" id="ntttGameTitle">Nested Tic-Tac-Toe</span>
                        <span class="nttt-turn-status" id="ntttTurnStatus">Your turn</span>
                    </div>
                    <button class="nttt-forfeit-btn" onclick="ntttForfeit()">üè≥ Forfeit</button>
                </div>
                <!-- Zoom/pan container -->
                <div class="nttt-viewport" id="ntttViewport">
                    <div class="nttt-board-root" id="ntttBoardRoot"></div>
                </div>
                <div class="nttt-zoom-controls">
                    <button onclick="ntttZoom(1.2)">Ôºã</button>
                    <button onclick="ntttZoomReset()">‚ü≤</button>
                    <button onclick="ntttZoom(0.8)">Ôºç</button>
                </div>
            </div>
        </div>

        <!-- INVITES TAB -->
        <div class="nttt-panel" id="ntttPanelInvites" style="display:none;">
            <div class="nttt-invites-section">
                <div class="nttt-section-label">Incoming</div>
                <div id="ntttIncomingList"><div class="nttt-empty">No incoming invites</div></div>
            </div>
            <div class="nttt-invites-section">
                <div class="nttt-section-label">Outgoing</div>
                <div id="ntttOutgoingList"><div class="nttt-empty">No outgoing invites</div></div>
            </div>
        </div>

        <!-- NEW GAME TAB -->
        <div class="nttt-panel" id="ntttPanelNew" style="display:none;">
            <div class="nttt-new-form">
                <div class="nttt-field">
                    <label>Challenge</label>
                    <select id="ntttPlayerSelect" class="nttt-select">
                        <option value="">-- Pick a player --</option>
                        <option value="open">üì¢ Open Challenge (anyone)</option>
                    </select>
                </div>
                <div class="nttt-field">
                    <label>Size: <span id="ntttSizeLabel">1</span>
                        <span class="nttt-size-hint" id="ntttSizeHint">(9 boards ‚Üí 81 cells)</span>
                    </label>
                    <div class="nttt-size-controls">
                        <button class="nttt-size-btn" onclick="ntttChangeSize(-1)">‚àí</button>
                        <input type="range" id="ntttSizeSlider" min="0" max="9" value="1" class="nttt-slider" oninput="ntttSetSize(parseInt(this.value))">
                        <button class="nttt-size-btn" onclick="ntttChangeSize(1)">+</button>
                    </div>
                    <div class="nttt-size-desc" id="ntttSizeDesc">9 boards in a 3√ó3 grid. Win 3 boards in a row to win.</div>
                </div>
                <button class="nttt-send-btn" onclick="ntttSendChallenge()">‚öîÔ∏è Send Challenge</button>
            </div>
        </div>
    </div>

    <!-- Toast notification -->
    <div class="game-toast" id="gameToast"></div>

    <!-- Profile card modal -->
    <div class="profile-card-overlay" id="profileCardOverlay">
        <div class="profile-card">
            <button class="profile-card-close" id="profileCardClose">‚úï</button>
            <div class="profile-card-avatar" id="profileCardAvatar"></div>
            <div class="profile-card-name" id="profileCardName"></div>
            <div class="profile-card-status" id="profileCardStatus"></div>
            <div class="profile-card-email" id="profileCardEmail"></div>
        </div>
    </div>

    <!-- Members list modal -->
    <div class="members-overlay" id="membersOverlay">
        <div class="members-panel">
            <div class="members-header">
                <h3>üë• Members</h3>
                <button class="members-close" id="membersClose">‚úï</button>
            </div>
            <div class="members-list" id="membersList">
                <div style="text-align:center;color:#888;padding:20px;">Loading...</div>
            </div>
        </div>
    </div>

    <script src="game-ttt.js"></script>
    <script src="app-cloudflare.js"></script>
</body>
</html>
